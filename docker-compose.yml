name: socialnet

services:
  #################################################################
  #                           DATABASES                           #
  #################################################################
  # =========================
  # USERS DB – SHARD 1 (repmgr)
  # =========================
  shard1-pg-0:
    platform: linux/amd64
    image: public.ecr.aws/bitnami/postgresql-repmgr:latest
    container_name: shard1-pg-0
    restart: unless-stopped
    environment:
      - POSTGRESQL_USERNAME=app
      - POSTGRESQL_PASSWORD=app_pass_shard1
      - POSTGRESQL_DATABASE=appdb
      - POSTGRESQL_POSTGRES_PASSWORD=supersecret
      - POSTGRESQL_SYNCHRONOUS_COMMIT=on
      - POSTGRESQL_NUM_SYNCHRONOUS_REPLICAS=1
      - REPMGR_PRIMARY_HOST=shard1-pg-0
      - REPMGR_NODE_NAME=shard1-pg-0
      - REPMGR_NODE_NETWORK_NAME=shard1-pg-0
      - REPMGR_PARTNER_NODES=shard1-pg-0,shard1-pg-1,shard1-pg-2
      - REPMGR_USERNAME=repl
      - REPMGR_PASSWORD=repl_pass
      - REPMGR_DATABASE=repmgr
      - REPMGR_PRIMARY_ROLE_WAIT=false
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d appdb"]
      interval: 10s
      timeout: 5s
      retries: 12
    volumes:
      - shard1-pg-0-data:/bitnami/postgresql
    networks:
      socialnet: {}
    ports:
      - "15432:5432"

  shard1-pg-1:
    platform: linux/amd64
    image: public.ecr.aws/bitnami/postgresql-repmgr:latest
    container_name: shard1-pg-1
    restart: unless-stopped
    depends_on:
      shard1-pg-0:
        condition: service_started
    environment:
      - POSTGRESQL_USERNAME=app
      - POSTGRESQL_PASSWORD=app_pass_shard1
      - POSTGRESQL_DATABASE=appdb
      - POSTGRESQL_POSTGRES_PASSWORD=supersecret
      - POSTGRESQL_SYNCHRONOUS_COMMIT=on
      - POSTGRESQL_NUM_SYNCHRONOUS_REPLICAS=1
      - REPMGR_PRIMARY_HOST=shard1-pg-0
      - REPMGR_NODE_NAME=shard1-pg-1
      - REPMGR_NODE_NETWORK_NAME=shard1-pg-1
      - REPMGR_PARTNER_NODES=shard1-pg-0,shard1-pg-1,shard1-pg-2
      - REPMGR_USERNAME=repl
      - REPMGR_PASSWORD=repl_pass
      - REPMGR_DATABASE=repmgr
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d appdb"]
      interval: 10s
      timeout: 5s
      retries: 12
    volumes:
      - shard1-pg-1-data:/bitnami/postgresql
    networks:
      socialnet: {}
    ports:
      - "15433:5432"

  shard1-pg-2:
    platform: linux/amd64
    image: public.ecr.aws/bitnami/postgresql-repmgr:latest
    container_name: shard1-pg-2
    restart: unless-stopped
    depends_on:
      shard1-pg-0:
        condition: service_started
    environment:
      - POSTGRESQL_USERNAME=app
      - POSTGRESQL_PASSWORD=app_pass_shard1
      - POSTGRESQL_DATABASE=appdb
      - POSTGRESQL_POSTGRES_PASSWORD=supersecret
      - POSTGRESQL_SYNCHRONOUS_COMMIT=on
      - POSTGRESQL_NUM_SYNCHRONOUS_REPLICAS=1
      - REPMGR_PRIMARY_HOST=shard1-pg-0
      - REPMGR_NODE_NAME=shard1-pg-2
      - REPMGR_NODE_NETWORK_NAME=shard1-pg-2
      - REPMGR_PARTNER_NODES=shard1-pg-0,shard1-pg-1,shard1-pg-2
      - REPMGR_USERNAME=repl
      - REPMGR_PASSWORD=repl_pass
      - REPMGR_DATABASE=repmgr
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d appdb"]
      interval: 10s
      timeout: 5s
      retries: 12
    volumes:
      - shard1-pg-2-data:/bitnami/postgresql
    networks:
      socialnet: {}
    ports:
      - "15434:5432"

  shard1-pgpool:
    platform: linux/amd64
    image: public.ecr.aws/bitnami/pgpool:latest
    container_name: shard1-pgpool
    restart: unless-stopped
    depends_on:
      shard1-pg-0:
        condition: service_healthy
      shard1-pg-1:
        condition: service_healthy
      shard1-pg-2:
        condition: service_healthy
    environment:
      - PGPOOL_BACKEND_NODES=0:shard1-pg-0:5432,1:shard1-pg-1:5432,2:shard1-pg-2:5432
      - PGPOOL_SR_CHECK_USER=repl
      - PGPOOL_SR_CHECK_PASSWORD=repl_pass
      - PGPOOL_POSTGRES_USERNAME=app
      - PGPOOL_POSTGRES_PASSWORD=app_pass_shard1
      - PGPOOL_ENABLE_LOAD_BALANCING=yes
      - PGPOOL_ADMIN_USERNAME=admin
      - PGPOOL_ADMIN_PASSWORD=adminpass
    healthcheck:
      test: ["CMD-SHELL", "bash -lc '</dev/tcp/127.0.0.1/5432' || exit 1"]
    networks:
      socialnet:
        aliases: [shard1-pgpool]
    ports:
      - "6433:5432"

  # =========================
  # USERS DB – SHARD 2 (repmgr)
  # =========================
  shard2-pg-0:
    platform: linux/amd64
    image: public.ecr.aws/bitnami/postgresql-repmgr:latest
    container_name: shard2-pg-0
    restart: unless-stopped
    environment:
      - POSTGRESQL_USERNAME=app
      - POSTGRESQL_PASSWORD=app_pass_shard2
      - POSTGRESQL_DATABASE=appdb
      - POSTGRESQL_POSTGRES_PASSWORD=supersecret
      - POSTGRESQL_SYNCHRONOUS_COMMIT=on
      - POSTGRESQL_NUM_SYNCHRONOUS_REPLICAS=1
      - REPMGR_PRIMARY_HOST=shard2-pg-0
      - REPMGR_NODE_NAME=shard2-pg-0
      - REPMGR_NODE_NETWORK_NAME=shard2-pg-0
      - REPMGR_PARTNER_NODES=shard2-pg-0,shard2-pg-1,shard2-pg-2
      - REPMGR_USERNAME=repl
      - REPMGR_PASSWORD=repl_pass
      - REPMGR_DATABASE=repmgr
      - REPMGR_PRIMARY_ROLE_WAIT=false
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d appdb"]
    volumes:
      - shard2-pg-0-data:/bitnami/postgresql
    networks:
      socialnet: {}
    ports:
      - "25432:5432"

  shard2-pg-1:
    platform: linux/amd64
    image: public.ecr.aws/bitnami/postgresql-repmgr:latest
    container_name: shard2-pg-1
    restart: unless-stopped
    depends_on:
      shard2-pg-0:
        condition: service_started
    environment:
      - POSTGRESQL_USERNAME=app
      - POSTGRESQL_PASSWORD=app_pass_shard2
      - POSTGRESQL_DATABASE=appdb
      - POSTGRESQL_POSTGRES_PASSWORD=supersecret
      - POSTGRESQL_SYNCHRONOUS_COMMIT=on
      - POSTGRESQL_NUM_SYNCHRONOUS_REPLICAS=1
      - REPMGR_PRIMARY_HOST=shard2-pg-0
      - REPMGR_NODE_NAME=shard2-pg-1
      - REPMGR_NODE_NETWORK_NAME=shard2-pg-1
      - REPMGR_PARTNER_NODES=shard2-pg-0,shard2-pg-1,shard2-pg-2
      - REPMGR_USERNAME=repl
      - REPMGR_PASSWORD=repl_pass
      - REPMGR_DATABASE=repmgr
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d appdb"]
    volumes:
      - shard2-pg-1-data:/bitnami/postgresql
    networks:
      socialnet: {}
    ports:
      - "25433:5432"

  shard2-pg-2:
    platform: linux/amd64
    image: public.ecr.aws/bitnami/postgresql-repmgr:latest
    container_name: shard2-pg-2
    restart: unless-stopped
    depends_on:
      shard2-pg-0:
        condition: service_started
    environment:
      - POSTGRESQL_USERNAME=app
      - POSTGRESQL_PASSWORD=app_pass_shard2
      - POSTGRESQL_DATABASE=appdb
      - POSTGRESQL_POSTGRES_PASSWORD=supersecret
      - POSTGRESQL_SYNCHRONOUS_COMMIT=on
      - POSTGRESQL_NUM_SYNCHRONOUS_REPLICAS=1
      - REPMGR_PRIMARY_HOST=shard2-pg-0
      - REPMGR_NODE_NAME=shard2-pg-2
      - REPMGR_NODE_NETWORK_NAME=shard2-pg-2
      - REPMGR_PARTNER_NODES=shard2-pg-0,shard2-pg-1,shard2-pg-2
      - REPMGR_USERNAME=repl
      - REPMGR_PASSWORD=repl_pass
      - REPMGR_DATABASE=repmgr
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d appdb"]
    volumes:
      - shard2-pg-2-data:/bitnami/postgresql
    networks:
      socialnet: {}
    ports:
      - "25434:5432"

  shard2-pgpool:
    platform: linux/amd64
    image: public.ecr.aws/bitnami/pgpool:latest
    container_name: shard2-pgpool
    restart: unless-stopped
    depends_on:
      shard2-pg-0:
        condition: service_healthy
      shard2-pg-1:
        condition: service_healthy
      shard2-pg-2:
        condition: service_healthy
    environment:
      - PGPOOL_BACKEND_NODES=0:shard2-pg-0:5432,1:shard2-pg-1:5432,2:shard2-pg-2:5432
      - PGPOOL_SR_CHECK_USER=repl
      - PGPOOL_SR_CHECK_PASSWORD=repl_pass
      - PGPOOL_POSTGRES_USERNAME=app
      - PGPOOL_POSTGRES_PASSWORD=app_pass_shard2
      - PGPOOL_ENABLE_LOAD_BALANCING=yes
      - PGPOOL_ADMIN_USERNAME=admin
      - PGPOOL_ADMIN_PASSWORD=adminpass
    healthcheck:
      test: ["CMD-SHELL", "bash -lc '</dev/tcp/127.0.0.1/5432' || exit 1"]
    networks:
      socialnet:
        aliases: [shard2-pgpool]
    ports:
      - "7433:5432"

  # -------------------------
  # OTHER Postgres DBs
  # -------------------------
  post-db:
    image: postgres:15
    container_name: post-db
    environment:
      POSTGRES_USER: post
      POSTGRES_PASSWORD: postpass
      POSTGRES_DB: post_db
    volumes:
      - post_db_data:/var/lib/postgresql/data
    networks:
      socialnet: {}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U post -d post_db"]
    ports:
      - "5434:5432"

  feedback-db:
    image: postgres:15
    container_name: feedback-db
    environment:
      POSTGRES_USER: feedback
      POSTGRES_PASSWORD: feedbackpass
      POSTGRES_DB: feedback_db
    volumes:
      - feedback_db_data:/var/lib/postgresql/data
    networks:
      socialnet: {}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U feedback -d feedback_db"]
    ports:
      - "5435:5432"

  message-db:
    image: postgres:15
    container_name: message-db
    environment:
      POSTGRES_USER: notify
      POSTGRES_PASSWORD: notifypass
      POSTGRES_DB: message_db
    volumes:
      - message_db_data:/var/lib/postgresql/data
    networks:
      socialnet: {}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U notify -d message_db"]
    ports:
      - "5436:5432"

  #################################################################
  #                           CACHES / QUEUES                     #
  #################################################################
  redis-feed:
    image: redis:7
    container_name: redis-feed
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_feed_data:/data
    networks:
      socialnet: {}
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]

  redis-message:
    image: redis:7
    container_name: redis-message
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_message_data:/data
    networks:
      socialnet: {}
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]

  redis-feedback:
    image: redis:7
    container_name: redis-feedback
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_feedback_data:/data
    networks:
      socialnet: {}
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]

  kafka:
    image: confluentinc/cp-kafka:7.7.1
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: "1"
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:9092"
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka:9093"
      KAFKA_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: "1"
      CLUSTER_ID: "MkU3OEVBNTcwNTJENDM2Qk"
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: "0"
    networks:
      socialnet: {}
    volumes:
      - kafka_data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --bootstrap-server localhost:9092 --list >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 20s

  #################################################################
  #                           MINIO / S3                          #
  #################################################################
  minio:
    image: minio/minio:latest
    container_name: minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio123
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      socialnet: {}
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9000/minio/health/ready || exit 1"]

  #################################################################
  #                       USER SERVICE (N SHARDS)                 #
  #################################################################
  user-service:
    build:
      context: ./services/user-service
    container_name: user-service
    volumes:
      - ./services/user-service:/app
    environment:
      APP_PORT: ":8081"
      NUM_SHARDS: "2"
      SHARDS_JSON: >
        [
          {"id":0,
          "writer":"host=shard1-pgpool port=5432 user=app password=app_pass_shard1 dbname=appdb sslmode=disable",
          "readers":[
            "host=shard1-pgpool port=5432 user=app password=app_pass_shard1 dbname=appdb sslmode=disable"
          ]},
          {"id":1,
          "writer":"host=shard2-pgpool port=5432 user=app password=app_pass_shard2 dbname=appdb sslmode=disable",
          "readers":[
            "host=shard2-pgpool port=5432 user=app password=app_pass_shard2 dbname=appdb sslmode=disable"
          ]}
        ]
      JWT_SECRET: "super-long-random-secret"
      AUTO_MIGRATE: "true"
      AIR_WATCHER_FORCE_POLLING: "true"
      AIR_TMP_DIR: "/app/tmp"
      # OpenTelemetry
      OTEL_EXPORTER_OTLP_ENDPOINT: "otel-collector:4318"
      OTEL_TRACES_SAMPLER: "parentbased_traceidratio"
      OTEL_TRACES_SAMPLER_ARG: "1.0"
      OTEL_RESOURCE_ATTRIBUTES: "service.name=user-service,service.version=1.0.0,env=local"
    depends_on:
      shard1-pgpool:
        condition: service_healthy
      shard2-pgpool:
        condition: service_healthy
      otel-collector:
        condition: service_started
    networks:
      socialnet: {}
    ports:
      - "8081:8081"

  #################################################################
  #                   OTHER CORE MICROSERVICES                    #
  #################################################################
  post-service:
    container_name: post-service
    build: ./services/post-service
    environment:
      DB_HOST: post-db
      DB_USER: post
      DB_PASSWORD: postpass
      DB_NAME: post_db
      MEDIA_SERVICE_URL: http://minio:9000
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    depends_on:
      post-db:
        condition: service_healthy
      kafka:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      socialnet: {}
    ports:
      - "8082:8082"

  feed-service:
    container_name: feed-service
    build:
      context: ./services/feed-service
      dockerfile: Dockerfile
    environment:
      REDIS_HOST: redis-feed
      REDIS_PORT: 6379
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    depends_on:
      redis-feed:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      socialnet: {}
    ports:
      - "8083:8083"

  feedback-service:
    container_name: feedback-service
    build: ./services/feedback-service
    environment:
      DB_HOST: feedback-db
      DB_USER: feedback
      DB_PASSWORD: feedbackpass
      DB_NAME: feedback_db
      REDIS_HOST: redis-feedback
      REDIS_PORT: 6379
    depends_on:
      feedback-db:
        condition: service_healthy
      redis-feedback:
        condition: service_healthy
    networks:
      socialnet: {}
    ports:
      - "8084:8084"

  message-service:
    container_name: message-service
    build: ./services/message-service
    environment:
      DB_HOST: message-db
      DB_USER: notify
      DB_PASSWORD: notifypass
      DB_NAME: message_db
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      REDIS_HOST: redis-message
      REDIS_PORT: 6379
    depends_on:
      message-db:
        condition: service_healthy
      kafka:
        condition: service_healthy
      redis-message:
        condition: service_healthy
    networks:
      socialnet: {}
    ports:
      - "8085:8085"

  notification-service:
    container_name: notification-service
    build: ./services/notification-service
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      socialnet: {}
    ports:
      - "8086:8086"

  media-service:
    container_name: media-service
    build: ./services/media-service
    environment:
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: minio
      S3_SECRET_KEY: minio123
    depends_on:
      minio:
        condition: service_healthy
    networks:
      socialnet: {}
    ports:
      - "8088:8088"

  #################################################################
  #                   API GATEWAY / LOAD BALANCER                 #
  #################################################################
  loadbalancer:
    image: nginx:latest
    container_name: loadbalancer
    depends_on:
      - api-gateway
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"
    networks:
      socialnet: {}

  api-gateway:
    container_name: api-gateway
    build: ./services/api-gateway
    environment:
      USER_SERVICE_URL: http://user-service:8081
      POST_SERVICE_URL: http://post-service:8082
      FEED_SERVICE_URL: http://feed-service:8083
      FEEDBACK_SERVICE_URL: http://feedback-service:8084
      MESSAGE_SERVICE_URL: http://message-service:8085
      MEDIA_SERVICE_URL: http://media-service:8088
      NOTIFICATION_SERVICE_URL: http://notification-service:8086
    depends_on:
      user-service:
        condition: service_started
      post-service:
        condition: service_started
      feed-service:
        condition: service_started
      feedback-service:
        condition: service_started
      message-service:
        condition: service_started
      media-service:
        condition: service_started
      notification-service:
        condition: service_started
    networks:
      socialnet: {}
    ports:
      - "8080:8080"

  #################################################################
  #                    SWAGGER UI FOR DOCS                        #
  #################################################################
  swagger-ui:
    image: swaggerapi/swagger-ui:latest
    container_name: swagger-ui
    depends_on:
      - api-gateway
    ports:
      - "9002:8080"
    environment:
      SWAGGER_JSON: /openapi/combined_openapi.yaml
    volumes:
      - ./combined_openapi.yaml:/openapi/combined_openapi.yaml:ro
    networks:
      socialnet: {}

  #################################################################
  #                        OBSERVABILITY                          #
  #################################################################
  otel-collector:
    image: otel/opentelemetry-collector:0.106.0
    container_name: otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./observability/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      - "4317:4317"
      - "4318:4318"
    networks:
      socialnet: {}

  jaeger:
    image: jaegertracing/all-in-one:1.59
    container_name: jaeger
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "16686:16686"
      - "14250:14250"
      - "14268:14268"
    networks:
      socialnet: {}

  loki:
    image: grafana/loki:2.9.8
    container_name: loki
    command: ["-config.file=/etc/loki/local-config.yaml"]
    volumes:
      - ./observability/loki-config.yaml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    ports:
      - "3100:3100"
    networks:
      socialnet: {}

  promtail:
    image: grafana/promtail:2.9.8
    container_name: promtail
    command: ["-config.file=/etc/promtail/config.yml"]
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./observability/promtail-config.yml:/etc/promtail/config.yml:ro
    networks:
      socialnet: {}

  prometheus:
    image: prom/prometheus:v2.55.1
    container_name: prometheus
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=15d"
    ports:
      - "9090:9090"
    networks:
      socialnet: {}

  grafana:
    image: grafana/grafana:11.1.0
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_DEFAULT_THEME=light
    volumes:
      - ./observability/grafana-datasources.yaml:/etc/grafana/provisioning/datasources/datasources.yaml
      - ./observability/grafana-dashboards.yaml:/etc/grafana/provisioning/dashboards/dashboards.yaml
      - ./observability/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
      - loki
    networks:
      socialnet: {}

  postgres-exporter-shard1:
    image: quay.io/prometheuscommunity/postgres-exporter:v0.15.0
    container_name: postgres-exporter-shard1
    environment:
      DATA_SOURCE_NAME: "postgresql://app:app_pass_shard1@shard1-pgpool:5432/appdb?sslmode=disable"
    ports: ["9187:9187"]
    networks: { socialnet: {} }
    depends_on: { shard1-pgpool: { condition: service_healthy } }

  postgres-exporter-shard2:
    image: quay.io/prometheuscommunity/postgres-exporter:v0.15.0
    container_name: postgres-exporter-shard2
    environment:
      DATA_SOURCE_NAME: "postgresql://app:app_pass_shard2@shard2-pgpool:5432/appdb?sslmode=disable"
    ports: ["9188:9187"]
    networks: { socialnet: {} }
    depends_on: { shard2-pgpool: { condition: service_healthy } }

  redis-exporter-feed:
    image: oliver006/redis_exporter:v1.62.0
    container_name: redis-exporter-feed
    command: ["--redis.addr=redis-feed:6379"]
    ports: ["9121:9121"]
    networks: { socialnet: {} }
    depends_on: { redis-feed: { condition: service_healthy } }

networks:
  socialnet:

volumes:
  # Users DB shards (HA)
  shard1-pg-0-data:
  shard1-pg-1-data:
  shard1-pg-2-data:
  shard2-pg-0-data:
  shard2-pg-1-data:
  shard2-pg-2-data:

  # Other Postgres
  post_db_data:
  feedback_db_data:
  message_db_data:

  # Redis
  redis_feed_data:
  redis_message_data:
  redis_feedback_data:

  # MinIO
  minio_data:

  # Kafka
  kafka_data:

  # Observability
  loki_data:
  prometheus_data:
  grafana_data:
