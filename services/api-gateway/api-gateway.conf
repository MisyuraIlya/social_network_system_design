# Virtual host for the API gateway
server {
  listen 80;
  # If you later add TLS, create a second server { listen 443 ssl; ... }

  # CORS (adjust Allowed-Origin to your frontend URL in prod)
  add_header Access-Control-Allow-Origin "*" always;
  add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Admin-Token, Idempotency-Key" always;
  add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
  if ($request_method = OPTIONS) { return 204; }

  # Healthcheck for LB/uptime
  location = /healthz { return 200 "ok"; add_header Content-Type text/plain; }

  # -------- Post Service --------
  location = /posts            { proxy_pass http://post_svc; }
  location  /posts/            { proxy_pass http://post_svc; }
  # e.g. /users/{id}/posts lives on post-service
  location  ~* ^/users/[^/]+/posts { proxy_pass http://post_svc; }

  # -------- Feed Service --------
  location  = /feed           { proxy_pass http://feed_svc; }
  location  /feed/            { proxy_pass http://feed_svc; }
  location  = /celebrities    { proxy_pass http://feed_svc; }
  location  /celebrities/     { proxy_pass http://feed_svc; }
  location  ~* ^/users/[^/]+/feed { proxy_pass http://feed_svc; }

  # -------- Message Service --------
  location  = /messages/upload {
    proxy_request_buffering off;   # stream uploads
    proxy_pass http://msg_svc;
  }
  location  /messages         { proxy_pass http://msg_svc; }
  location  /messages/        { proxy_pass http://msg_svc; }
  location  /chats            { proxy_pass http://msg_svc; }
  location  /chats/           { proxy_pass http://msg_svc; }

  # -------- Feedback Service (likes/comments) --------
  location  ~* ^/posts/\d+/like      { proxy_pass http://feedback_svc; }
  location  ~* ^/posts/\d+/likes     { proxy_pass http://feedback_svc; }
  location  ~* ^/posts/\d+/comments  { proxy_pass http://feedback_svc; }
  location  /comments         { proxy_pass http://feedback_svc; }
  location  /likes            { proxy_pass http://feedback_svc; }

  # -------- Media Service --------
  location  = /media/upload {
    proxy_request_buffering off;   # stream uploads
    proxy_pass http://media_svc;
  }
  location  /media/           { proxy_pass http://media_svc; }
  location  /media            { proxy_pass http://media_svc; }
  # public GETs like /media/{key} are served (302) by media-service itself

  # -------- Notification Service (optional) --------
  location  /notifications    { proxy_pass http://notif_svc; }
  location  /notifications/   { proxy_pass http://notif_svc; }

  # -------- User Service --------
  location  /whoami           { proxy_pass http://user_svc; }    # if exposed
  location  /relationships    { proxy_pass http://user_svc; }    # used by feed rebuild
  # add more user routes as needed:
  # location /users            { proxy_pass http://user_svc; }
  # location /users/           { proxy_pass http://user_svc; }
}
